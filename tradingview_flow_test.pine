//@version=5

// =====================================================================
// æµç¨‹é©—è­‰æ¸¬è©¦ç­–ç•¥ (tradingview_flow_test.pine)
//
// ç”¨é€”ï¼šå¿«é€Ÿé©—è­‰ TradingView â†’ API /signal/simple â†’ çµ±ä¸€æœŸè²¨ æ•´å¥—æµç¨‹
//       æ¶µè“‹æ‰€æœ‰ 4 ç¨®è¨Šè™Ÿçµ„åˆï¼š
//         â‘  entry + buy  (åšå¤šé€²å ´)
//         â‘¡ exit  + sell (åšå¤šå‡ºå ´)
//         â‘¢ entry + sell (åšç©ºé€²å ´)
//         â‘£ exit  + buy  (åšç©ºå‡ºå ´)
//
// ä½¿ç”¨æ–¹å¼ï¼š
//   1. è¼‰å…¥åˆ° TXFF5 1åˆ†é˜åœ– â†’ MAäº¤å‰é »ç¹ï¼Œè¨Šè™Ÿå¿«é€Ÿè§¸ç™¼
//   2. TradingView Alert è¨­å®šï¼š
//      - æ¢ä»¶ï¼šé¸æ“‡æ­¤ç­–ç•¥ï¼ŒOrder fills only
//      - è¨Šæ¯ï¼š{{strategy.order.alert_message}}
//      - Webhook URLï¼šhttps://your-api-url/signal/simple
//   3. è§€å¯Ÿ API /signals è¨˜éŒ„ç¢ºèªæµç¨‹æ­£å¸¸
//
// æ³¨æ„ï¼š
//   - ç­–ç•¥åç¨±éœ€èˆ‡å¾Œç«¯ strategy_config.strategy_name ä¸€è‡´
//   - Alert åƒ…åœ¨å³æ™‚ K æ£’è§¸ç™¼æ™‚ç™¼é€ Webhookï¼Œå›žæ¸¬æ¨™ç±¤åƒ…ä¾›ç›®è¦–ç¢ºèª
//   - æ¸¬è©¦å®Œæˆå¾Œè«‹åœç”¨æ­¤ Alertï¼Œé¿å…èª¤è§¸æ­£å¼ä¸‹å–®
// =====================================================================

strategy("ðŸ§ª æµç¨‹é©—è­‰æ¸¬è©¦", overlay=true, pyramiding=0,
     default_qty_type=strategy.fixed, default_qty_value=1,
     max_bars_back=100)

// ==================== è¨­å®šåƒæ•¸ ====================
strategyName = input.string(
    "TXF_vivi",
    title="ç­–ç•¥åç¨±",
    tooltip="å¿…é ˆèˆ‡å¾Œç«¯ strategy_config.strategy_name å®Œå…¨ä¸€è‡´")

testQty = input.int(
    1,
    title="æ¸¬è©¦å£æ•¸",
    minval=1,
    tooltip="å‚³é€çµ¦ API çš„ quantity å€¼ï¼Œå¯¦éš›å£æ•¸ç”±å¾Œç«¯ä¹˜æ•¸æ±ºå®š")

fastLen = input.int(3,  title="å¿«é€Ÿ MA é€±æœŸ", minval=2)
slowLen = input.int(8,  title="æ…¢é€Ÿ MA é€±æœŸ", minval=3)

testLong  = input.bool(true,  title="âœ… æ¸¬è©¦åšå¤šæ–¹å‘ (â‘  entry+buy / â‘¡ exit+sell)")
testShort = input.bool(true,  title="âœ… æ¸¬è©¦åšç©ºæ–¹å‘ (â‘¢ entry+sell / â‘£ exit+buy)")

// ==================== makeAlert è¼”åŠ©å‡½å¼ ====================
// ç”¢ç”Ÿç¬¦åˆ /signal/simple ç«¯é»žçš„ JSON è¨Šæ¯
// åƒæ•¸ï¼š
//   action   - "entry" æˆ– "exit"
//   side     - "buy"   æˆ– "sell"
//   price    - è§¸ç™¼æ™‚çš„åƒ¹æ ¼ï¼ˆæ•´æ•¸ï¼‰
//   stopLoss - æ­¢æåƒ¹æ ¼ï¼Œ0 è¡¨ç¤ºä¸å‚³é€
//   note     - å‚™è¨»æ¨™ç±¤ï¼ˆæœ€é•· 10 å­—ï¼‰
makeAlert(action, side, price, stopLoss = 0.0, note = "") =>
    msg = '{"strategy":"' + strategyName + '"'
    msg := msg + ',"action":"'   + action + '"'
    msg := msg + ',"side":"'     + side   + '"'
    msg := msg + ',"quantity":'  + str.tostring(testQty)
    msg := msg + ',"price":'     + str.tostring(math.round(price))
    if stopLoss > 0
        msg := msg + ',"stop_loss":' + str.tostring(math.round(stopLoss))
    msg := msg + ',"note":"'     + note   + '"'
    msg := msg + '}'
    msg

// ==================== è¨Šè™Ÿè¨ˆç®— ====================
fastMA = ta.sma(close, fastLen)
slowMA = ta.sma(close, slowLen)

plot(fastMA, title="å¿«é€Ÿ MA", color=color.new(color.blue,   20), linewidth=2)
plot(slowMA, title="æ…¢é€Ÿ MA", color=color.new(color.orange, 20), linewidth=2)

// é»ƒé‡‘äº¤å‰ï¼šå¿«ç·šç”±ä¸‹å¾€ä¸Šç©¿è¶Šæ…¢ç·š â†’ åšå¤šæ–¹å‘
bullCross = ta.crossover(fastMA, slowMA)
// æ­»äº¡äº¤å‰ï¼šå¿«ç·šç”±ä¸Šå¾€ä¸‹ç©¿è¶Šæ…¢ç·š â†’ åšç©ºæ–¹å‘
bearCross = ta.crossunder(fastMA, slowMA)

isLong  = strategy.position_size > 0
isShort = strategy.position_size < 0
isFlat  = strategy.position_size == 0

// ==================== â‘  åšå¤šé€²å ´ï¼šentry + buy ====================
if bullCross and isFlat and testLong
    slPrice = ta.lowest(low, 5)   // æœ€è¿‘ 5 æ ¹ä½Žé»žä½œç‚ºæ­¢æåƒè€ƒ
    strategy.entry("Long", strategy.long, qty=testQty,
        comment="â‘  entry+buy",
        alert_message=makeAlert("entry", "buy", close, slPrice, "LongEntry"))
    label.new(bar_index, low * 0.999,
        text="â‘  entry\nbuy",
        style=label.style_label_up,
        color=color.lime, textcolor=color.black, size=size.small)

// ==================== â‘¡ åšå¤šå‡ºå ´ï¼šexit + sell ====================
if bearCross and isLong
    strategy.close("Long",
        comment="â‘¡ exit+sell",
        alert_message=makeAlert("exit", "sell", close, 0, "LongExit"))
    label.new(bar_index, high * 1.001,
        text="â‘¡ exit\nsell",
        style=label.style_label_down,
        color=color.red, textcolor=color.white, size=size.small)

// ==================== â‘¢ åšç©ºé€²å ´ï¼šentry + sell ====================
if bearCross and isFlat and testShort
    slPrice = ta.highest(high, 5)  // æœ€è¿‘ 5 æ ¹é«˜é»žä½œç‚ºæ­¢æåƒè€ƒ
    strategy.entry("Short", strategy.short, qty=testQty,
        comment="â‘¢ entry+sell",
        alert_message=makeAlert("entry", "sell", close, slPrice, "ShortEntry"))
    label.new(bar_index, high * 1.001,
        text="â‘¢ entry\nsell",
        style=label.style_label_down,
        color=color.maroon, textcolor=color.white, size=size.small)

// ==================== â‘£ åšç©ºå‡ºå ´ï¼šexit + buy ====================
if bullCross and isShort
    strategy.close("Short",
        comment="â‘£ exit+buy",
        alert_message=makeAlert("exit", "buy", close, 0, "ShortExit"))
    label.new(bar_index, low * 0.999,
        text="â‘£ exit\nbuy",
        style=label.style_label_up,
        color=color.blue, textcolor=color.white, size=size.small)

// ==================== è³‡è¨Šé¢æ¿ ====================
var table panel = table.new(position.top_right, 2, 8,
    bgcolor=color.new(color.black, 55),
    border_width=1, frame_color=color.gray, frame_width=1)

if barstate.islast
    table.cell(panel, 0, 0, "ðŸ§ª æµç¨‹é©—è­‰è¨­å®š",
        text_color=color.white, text_size=size.normal,
        bgcolor=color.new(color.navy, 40), colspan=2)

    table.cell(panel, 0, 1, "ç­–ç•¥åç¨±",       text_color=color.silver, text_size=size.small)
    table.cell(panel, 1, 1, strategyName,     text_color=color.yellow, text_size=size.small)

    table.cell(panel, 0, 2, "Webhook ç«¯é»ž",   text_color=color.silver, text_size=size.small)
    table.cell(panel, 1, 2, "/signal/simple", text_color=color.aqua,   text_size=size.small)

    table.cell(panel, 0, 3, "â‘  entry + buy",
        text_color=color.silver, text_size=size.small)
    table.cell(panel, 1, 3, testLong ? "å•Ÿç”¨ âœ…" : "åœç”¨ â¬œ",
        text_color=testLong ? color.lime : color.gray, text_size=size.small)

    table.cell(panel, 0, 4, "â‘¡ exit  + sell",
        text_color=color.silver, text_size=size.small)
    table.cell(panel, 1, 4, testLong ? "å•Ÿç”¨ âœ…" : "åœç”¨ â¬œ",
        text_color=testLong ? color.lime : color.gray, text_size=size.small)

    table.cell(panel, 0, 5, "â‘¢ entry + sell",
        text_color=color.silver, text_size=size.small)
    table.cell(panel, 1, 5, testShort ? "å•Ÿç”¨ âœ…" : "åœç”¨ â¬œ",
        text_color=testShort ? color.lime : color.gray, text_size=size.small)

    table.cell(panel, 0, 6, "â‘£ exit  + buy",
        text_color=color.silver, text_size=size.small)
    table.cell(panel, 1, 6, testShort ? "å•Ÿç”¨ âœ…" : "åœç”¨ â¬œ",
        text_color=testShort ? color.lime : color.gray, text_size=size.small)

    posText = isLong ? "æŒå¤šå€‰ ðŸ“ˆ" : isShort ? "æŒç©ºå€‰ ðŸ“‰" : "ç„¡éƒ¨ä½ âž–"
    posColor = isLong ? color.lime : isShort ? color.red : color.gray
    table.cell(panel, 0, 7, "ç›®å‰éƒ¨ä½",   text_color=color.silver, text_size=size.small)
    table.cell(panel, 1, 7, posText,      text_color=posColor,     text_size=size.small)
